<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Voltage & Current</title>

    <!-- UI Frameworks -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        mono: ['JetBrains Mono', 'monospace'],
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a',
                        },
                        slate: {
                            950: '#020617',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            opacity: 0;
            transition: opacity 0.4s ease-out;
        }

        .admin-ready body {
            opacity: 1;
        }

        .sidebar-link.active {
            background-color: #2563eb;
            color: white;
            box-shadow: 4px 4px 0px 0px rgba(15, 23, 42, 1);
            border: 2px solid #0f172a;
        }

        .sidebar-link.active i {
            color: white;
        }

        .bg-grid-subtle {
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .shadow-tech {
            box-shadow: 6px 6px 0px 0px rgba(15, 23, 42, 1);
        }

        .shadow-tech-accent {
            box-shadow: 6px 6px 0px 0px rgba(37, 99, 235, 1);
        }

        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            left: 1rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            pointer-events: none;
        }

        @media (min-width: 640px) {
            .toast-container {
                left: auto;
                bottom: 2rem;
                right: 2rem;
                width: auto;
            }
        }

        .toast-item {
            pointer-events: auto;
            max-width: 100%;
            animation: slideIn 0.3s ease-out;
            background: white;
            border: 2px solid #0f172a;
        }

        @media (min-width: 640px) {
            .toast-item {
                max-width: 28rem;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .tab-content {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .tab-content.hidden {
            display: none !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #0f172a;
            border-radius: 0;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }

        .mobile-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(4px);
            z-index: 45;
        }

        .mobile-backdrop.active {
            display: block;
        }

        .border-tech {
            border: 2px solid #0f172a;
        }

        @keyframes bounce-subtle {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        .animate-bounce-subtle {
            animation: bounce-subtle 3s infinite ease-in-out;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen flex">

    <!-- Toast Registry -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Mobile Backdrop -->
    <div id="mobile-backdrop" class="mobile-backdrop lg:hidden" onclick="window.toggleMobileSidebar()"></div>

    <!-- Sidebar Navigation -->
    <aside
        class="w-72 bg-slate-950 text-white flex flex-col fixed inset-y-0 left-0 z-50 transition-all duration-500 lg:translate-x-0 -translate-x-full border-r-2 border-white/10 lg:w-72 w-[85%] max-w-sm h-full"
        id="sidebar">
        <!-- Add Close Button for Mobile -->
        <button onclick="window.toggleMobileSidebar()"
            class="btn btn-ghost btn-circle absolute top-4 right-4 lg:hidden text-white">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>

        <div class="p-8 border-b border-white/10">
            <a href="index.html" class="flex items-center gap-3">
                <span
                    class="bg-blue-600 text-white w-10 h-10 flex items-center justify-center font-black text-xl">V</span>
                <div class="flex flex-col">
                    <span class="font-black text-xl tracking-tighter leading-none uppercase">Admin</span>
                    <span
                        class="text-[9px] font-mono font-bold tracking-[0.3em] text-blue-400 mt-1 uppercase">Dashboard</span>
                </div>
            </a>
        </div>

        <nav class="flex-1 p-6 space-y-2 overflow-y-auto">
            <div class="text-[10px] font-mono font-bold text-slate-500 uppercase tracking-widest mb-4 px-2">Main Menu
            </div>

            <button
                class="sidebar-link w-full flex items-center gap-4 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 transition-all active"
                data-tab="posts">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                <span class="font-bold text-sm">Articles</span>
            </button>

            <button
                class="sidebar-link w-full flex items-center gap-4 px-6 py-4 text-slate-400 hover:text-white hover:bg-white/5 transition-all"
                data-tab="users">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span class="font-bold text-sm">Users</span>
            </button>

            <button
                class="sidebar-link w-full flex items-center gap-4 px-6 py-4 text-slate-400 hover:text-white hover:bg-white/5 transition-all"
                data-tab="comments">
                <i data-lucide="message-square" class="w-5 h-5"></i>
                <span class="font-bold text-sm">Comments</span>
            </button>

            <div class="pt-6 text-[10px] font-mono font-bold text-slate-500 uppercase tracking-widest mb-4 px-2">
                Organization</div>

            <button
                class="sidebar-link w-full flex items-center gap-4 px-6 py-4 text-slate-400 hover:text-white hover:bg-white/5 transition-all"
                data-tab="categories">
                <i data-lucide="tag" class="w-5 h-5"></i>
                <span class="font-bold text-sm">Categories</span>
            </button>

            <button
                class="sidebar-link w-full flex items-center gap-4 px-6 py-4 text-slate-400 hover:text-white hover:bg-white/5 transition-all"
                data-tab="resources">
                <i data-lucide="library" class="w-5 h-5"></i>
                <span class="font-bold text-sm">Library</span>
            </button>

            <div class="pt-6 text-[10px] font-mono font-bold text-slate-500 uppercase tracking-widest mb-4 px-2">
                Settings</div>

            <a href="profile.html"
                class="sidebar-link w-full flex items-center gap-4 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 transition-all">
                <i data-lucide="user-cog" class="w-5 h-5"></i>
                <span class="font-bold text-sm">My Profile</span>
            </a>
        </nav>

        <div class="p-6 border-t border-white/10" id="sidebar-footer">
            <button onclick="window.performSignOut()"
                class="w-full flex items-center gap-4 px-4 py-3 text-red-400 hover:text-white hover:bg-red-500/20 transition-all">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span class="font-bold text-sm">Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 lg:ml-72 flex flex-col">

        <!-- Header -->
        <header
            class="h-20 bg-white border-b-2 border-slate-900 sticky top-0 z-40 px-1 sm:px-8 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button onclick="window.toggleMobileSidebar()" class="btn btn-ghost btn-circle lg:hidden">
                    <i data-lucide="menu" class="w-6 h-6 text-slate-900"></i>
                </button>
                <span class="font-black text-xl uppercase tracking-tighter lg:block hidden">Admin Dashboard</span>
                <span class="font-black text-xl uppercase tracking-tighter lg:hidden block">Admin</span>
            </div>

            <div class="flex items-center gap-3 bg-slate-900 px-4 py-1.5 border border-slate-900 hidden sm:flex">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-[10px] font-mono font-bold uppercase tracking-widest text-white">Online</span>
            </div>

            <div class="flex items-center gap-2 sm:gap-6" id="auth-header-info">
                <!-- User Profile Summary -->
            </div>
        </header>


        <!-- Dashboard Content -->
        <div class="p-4 sm:p-8 lg:p-12 bg-grid-subtle flex-1">

            <!-- Page Title -->
            <div class="mb-10 flex flex-col xl:flex-row xl:items-end justify-between gap-8">
                <div>
                    <div
                        class="flex items-center gap-2 text-[10px] font-mono font-bold text-blue-600 uppercase tracking-widest mb-2">
                        <span>Main</span>
                        <i data-lucide="chevron-right" class="w-3 h-3"></i>
                        <span class="text-slate-400" id="active-tab-breadcrumb">Articles</span>
                    </div>
                    <h1 class="text-4xl font-black text-slate-900 tracking-tighter uppercase mb-2"
                        id="active-tab-title">Admin Dashboard</h1>
                    <p class="text-slate-500 text-xs font-medium uppercase tracking-widest" id="active-tab-subtitle">
                        Manage your website content</p>
                </div>

                <div class="flex flex-col md:flex-row items-stretch md:items-center gap-4 w-full md:w-auto">
                    <!-- Search Bar -->
                    <div class="relative w-full md:w-80 group" id="search-container">
                        <i data-lucide="search"
                            class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                        <input type="text" id="global-search" placeholder="Search..."
                            class="input input-bordered w-full pl-12 rounded-none border-2 border-slate-900 font-bold text-sm bg-white focus:outline-none focus:shadow-tech-accent transition-all h-12" />
                    </div>

                    <div id="tab-actions" class="flex items-center gap-3 w-full md:w-auto">
                        <!-- Actions specific to each tab -->
                    </div>
                </div>
            </div>

            <!-- Tab Content Sections -->

            <!-- Posts Tab -->
            <section id="tab-posts" class="tab-content">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div
                        class="bg-white p-6 border-2 border-slate-900 shadow-tech group hover:border-blue-600 transition-colors">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-slate-900 text-white transition-colors">
                                <i data-lucide="file-text" class="w-6 h-6"></i>
                            </div>
                            <span class="text-[10px] font-mono font-bold text-slate-400 uppercase tracking-widest">Total
                                Posts</span>
                        </div>
                        <div class="text-3xl font-black text-slate-900" id="stat-posts">0</div>
                    </div>
                </div>
                <div class="flex flex-col gap-6" id="posts-container">
                    <!-- Posts loaded here -->
                </div>
            </section>

            <!-- Users Tab -->
            <section id="tab-users" class="tab-content hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div
                        class="bg-white p-6 border-2 border-slate-900 shadow-tech group hover:border-blue-600 transition-colors">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-slate-900 text-white transition-colors">
                                <i data-lucide="users" class="w-6 h-6"></i>
                            </div>
                            <span
                                class="text-[10px] font-mono font-bold text-slate-400 uppercase tracking-widest">Active
                                Users</span>
                        </div>
                        <div class="text-3xl font-black text-slate-900" id="stat-users">0</div>
                    </div>
                </div>
                <div class="bg-white border-2 border-slate-900 shadow-tech overflow-hidden">
                    <!-- Table Header (Desktop Only) -->
                    <div
                        class="hidden md:grid grid-cols-12 bg-slate-50 border-b-2 border-slate-900 py-4 px-6 items-center">
                        <div class="col-span-6 font-black uppercase tracking-widest text-[10px] text-slate-900">User
                        </div>
                        <div class="col-span-3 font-black uppercase tracking-widest text-[10px] text-slate-900">Role
                        </div>
                        <div
                            class="col-span-3 font-black uppercase tracking-widest text-[10px] text-slate-900 text-right">
                            Options</div>
                    </div>
                    <div id="users-container" class="divide-y divide-slate-200">
                        <!-- Users loaded here -->
                    </div>
                </div>
            </section>

            <!-- Comments Tab -->
            <section id="tab-comments" class="tab-content hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div
                        class="bg-white p-6 border-2 border-slate-900 shadow-tech group hover:border-blue-600 transition-colors">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-slate-900 text-white transition-colors">
                                <i data-lucide="message-square" class="w-6 h-6"></i>
                            </div>
                            <span
                                class="text-[10px] font-mono font-bold text-slate-400 uppercase tracking-widest">Recent
                                Comments</span>
                        </div>
                        <div class="text-3xl font-black text-slate-900" id="stat-comments">0</div>
                    </div>
                </div>
                <div id="comments-container" class="space-y-6">
                    <!-- Comments loaded here -->
                </div>
            </section>

            <!-- Categories Tab -->
            <section id="tab-categories" class="tab-content hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div
                        class="bg-white p-6 border-2 border-slate-900 shadow-tech group hover:border-blue-600 transition-colors">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-slate-900 text-white transition-colors">
                                <i data-lucide="hash" class="w-6 h-6"></i>
                            </div>
                            <span
                                class="text-[10px] font-mono font-bold text-slate-400 uppercase tracking-widest">Active
                                Categories</span>
                        </div>
                        <div class="text-3xl font-black text-slate-900" id="stat-categories">0</div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6" id="categories-container">
                    <!-- Categories loaded here -->
                </div>
            </section>

            <!-- Resources Tab -->
            <section id="tab-resources" class="tab-content hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div
                        class="bg-white p-6 border-2 border-slate-900 shadow-tech group hover:border-blue-600 transition-colors">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-slate-900 text-white transition-colors">
                                <i data-lucide="archive" class="w-6 h-6"></i>
                            </div>
                            <span class="text-[10px] font-mono font-bold text-slate-400 uppercase tracking-widest">Total
                                Resources</span>
                        </div>
                        <div class="text-3xl font-black text-slate-900" id="stat-resources">0</div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="admin-resources-container">
                    <!-- Resources loaded here -->
                </div>
            </section>

        </div>
    </main>

    <!-- Modals (DaisyUI) -->
    <!-- Category Modal -->
    <input type="checkbox" id="modal-category" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box rounded-none p-4 md:p-8 border-2 border-slate-900 shadow-tech bg-white w-full max-w-lg">
            <h3 class="font-black text-2xl uppercase tracking-tighter mb-6" id="category-modal-title">New Category</h3>
            <div class="space-y-4">
                <div class="form-control">
                    <label class="label"><span
                            class="label-text font-bold text-[10px] uppercase tracking-widest text-slate-500">Category
                            Name</span></label>
                    <input type="text" id="cat-name"
                        class="input input-bordered rounded-none border-2 border-slate-900 font-bold"
                        placeholder="e.g. Power Electronics" />
                </div>
                <div class="form-control">
                    <label class="label"><span
                            class="label-text font-bold text-[10px] uppercase tracking-widest text-slate-500">Short Link
                            (Slug)</span></label>
                    <input type="text" id="cat-slug"
                        class="input input-bordered rounded-none border-2 border-slate-900 font-mono text-sm"
                        placeholder="power-electronics" />
                </div>
            </div>
            <div class="modal-action">
                <label for="modal-category"
                    class="btn btn-ghost rounded-none font-bold uppercase tracking-widest text-[10px] border-2 border-transparent">Cancel</label>
                <button id="save-category-btn"
                    class="btn btn-primary rounded-none px-10 font-bold uppercase tracking-widest text-[10px] border-2 border-slate-900 shadow-tech">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <!-- Resource Modal -->
    <input type="checkbox" id="modal-resource" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box rounded-none p-4 md:p-8 border-2 border-slate-900 shadow-tech bg-white w-full max-w-lg">
            <h3 class="font-black text-2xl uppercase tracking-tighter mb-6">Add New Resource</h3>
            <div class="space-y-4">
                <div class="form-control">
                    <label class="label"><span
                            class="label-text font-bold text-[10px] uppercase tracking-widest text-slate-500">Title</span></label>
                    <input type="text" id="res-title"
                        class="input input-bordered rounded-none border-2 border-slate-900 font-bold"
                        placeholder="e.g. Voltage Drop Calculator" />
                </div>
                <div class="form-control">
                    <label class="label"><span
                            class="label-text font-bold text-[10px] uppercase tracking-widest text-slate-500">Category</span></label>
                    <input type="text" id="res-category"
                        class="input input-bordered rounded-none border-2 border-slate-900 font-bold"
                        placeholder="Engineering Tools" />
                </div>
                <div class="form-control">
                    <label class="label"><span
                            class="label-text font-bold text-[10px] uppercase tracking-widest text-slate-500">File Name
                            / Info</span></label>
                    <input type="text" id="res-file"
                        class="input input-bordered rounded-none border-2 border-slate-900 font-mono text-sm"
                        placeholder="v_calc_v2.exe" />
                </div>
            </div>
            <div class="modal-action">
                <label for="modal-resource"
                    class="btn btn-ghost rounded-none font-bold uppercase tracking-widest text-[10px] border-2 border-transparent">Cancel</label>
                <button id="save-resource-btn"
                    class="btn btn-primary rounded-none px-10 font-bold uppercase tracking-widest text-[10px] border-2 border-slate-900 shadow-tech">Add
                    Resource</button>
            </div>
        </div>
    </div>

    <!-- Back to Home Button -->
    <a href="index.html"
        class="fixed bottom-6 right-6 z-[60] flex items-center justify-center px-6 py-3 bg-white/20 backdrop-blur-md border-2 border-slate-900 text-slate-900 shadow-tech hover:shadow-tech-accent hover:-translate-y-1 transition-all group active:translate-y-0 active:shadow-none animate-bounce-subtle"
        title="Return to Main Site">
        <span class="text-[10px] font-black uppercase tracking-[0.2em] group-hover:text-blue-600 transition-colors">[
            BACK TO HOME ]</span>
    </a>

    <script type="module">
        import { checkSession, signOut } from './js/auth.js';
        import { getAllPosts, deletePost, getCategories, createCategory, updateCategory, deleteCategory } from './js/posts.js';
        import { getAllComments, deleteComment } from './js/comments.js';
        import { getResources, createResource, deleteResource } from './js/resources.js';
        import { getProfile } from './js/profiles.js';
        import { formatDate, renderNavbar, sanitizeHTML, debounce } from './js/utils.js';
        import { supabase } from './js/supabase-client.js';

        // --- App State ---
        const App = {
            user: null,
            profile: null,
            activeTab: 'posts',
            data: {
                posts: [],
                users: [],
                comments: [],
                categories: [],
                resources: []
            },
            searchQuery: ''
        };

        // --- Core Functions ---

        async function init() {
            try {
                const session = await checkSession();
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }
                App.user = session.user;

                const { data: profile, error: profileError } = await getProfile(App.user.id);
                if (profileError) throw profileError;

                const role = profile?.role || 'author';
                if (role !== 'admin' && role !== 'administrator') {
                    showUnauthorized();
                    return;
                }

                App.profile = profile;
                document.documentElement.classList.add('admin-ready');

                renderHeaderInfo(App.profile);
                setupCoreUI();

                // Concurrent Load
                await Promise.all([
                    loadStats(),
                    loadTabData('posts')
                ]);

                lucide.createIcons();

            } catch (err) {
                console.error("Dashboard_Init_Failure:", err);
                showSystemError(err.message);
            }
        }

        /**
         * Generic wrapper for async actions to handle loading, errors, and feedback
         */
        async function runAction(taskName, actionFn, successMsg = 'Operation successful') {
            try {
                const result = await actionFn();
                if (result?.error) throw result.error;

                showToast(successMsg, 'success');
                return result;
            } catch (err) {
                console.error(`Action_Error [${taskName}]:`, err);
                showToast(`${taskName} failed: ${err.message}`, 'error');
                return { error: err };
            }
        }

        async function loadStats() {
            try {
                const [posts, profiles, comments, categories, resources] = await Promise.all([
                    supabase.from('posts').select('*', { count: 'exact', head: true }),
                    supabase.from('profiles').select('*', { count: 'exact', head: true }),
                    supabase.from('comments').select('*', { count: 'exact', head: true }),
                    supabase.from('categories').select('*', { count: 'exact', head: true }),
                    supabase.from('resources').select('*', { count: 'exact', head: true })
                ]);

                updateStatCounter('stat-posts', posts.count);
                updateStatCounter('stat-users', profiles.count);
                updateStatCounter('stat-comments', comments.count);
                updateStatCounter('stat-categories', categories.count);
                updateStatCounter('stat-resources', resources.count);
            } catch (err) {
                console.warn("Stats_Refresh_Interrupted");
            }
        }

        function updateStatCounter(id, val) {
            const el = document.getElementById(id);
            if (el) el.innerText = val ?? 0;
        }

        // --- Tab Management ---

        async function loadTabData(tabId = App.activeTab) {
            const container = getTabContainer(tabId);
            if (!container) return;

            // Show local loader
            container.innerHTML = `<div class="p-20 text-center"><span class="loading loading-spinner text-blue-600"></span></div>`;

            try {
                let result;
                switch (tabId) {
                    case 'posts': result = await getAllPosts(); break;
                    case 'users': result = await supabase.from('profiles').select('*').order('created_at', { ascending: false }); break;
                    case 'comments': result = await getAllComments(); break;
                    case 'categories': result = await getCategories(); break;
                    case 'resources':
                        const res = await getResources();
                        result = { data: res, error: null };
                        break;
                }

                if (result.error) throw result.error;

                App.data[tabId] = result.data || [];

                // Always render the tab we just loaded, even if it's not active anymore 
                // (it will be hidden by CSS anyway, but correctly populated for when it is shown)
                renderTab(tabId);
            } catch (err) {
                container.innerHTML = `<div class="p-10 text-red-500 font-mono text-xs uppercase text-center">Load Error: ${err.message}</div>`;
                showToast(`Failed to load ${tabId}: ${err.message}`, 'error');
            }
        }

        function renderActiveTab() {
            renderTab(App.activeTab);
        }

        function renderTab(tabId) {
            const container = getTabContainer(tabId);
            if (!container) return;

            const query = App.searchQuery.toLowerCase();
            let data = App.data[tabId] || [];

            if (query) {
                data = data.filter(item => {
                    const s = (val) => (val || '').toString().toLowerCase();
                    if (tabId === 'posts') return s(item.title).includes(query) || s(item.categories?.name).includes(query);
                    if (tabId === 'users') return s(item.full_name).includes(query) || s(item.id).includes(query);
                    if (tabId === 'comments') return s(item.content).includes(query) || s(item.profiles?.full_name).includes(query);
                    if (tabId === 'categories') return s(item.name).includes(query) || s(item.slug).includes(query);
                    if (tabId === 'resources') return s(item.title).includes(query) || s(item.category).includes(query) || s(item.file_info).includes(query);
                    return true;
                });
            }

            if (!data.length) {
                const emptyClass = "bg-white border-2 border-dashed border-slate-200 p-8 sm:p-20 rounded-none text-center text-slate-400 font-bold uppercase tracking-widest text-xs sm:text-base";
                if (App.searchQuery) {
                    container.innerHTML = `<div class="${emptyClass}">No matching results for "${query}"</div>`;
                } else if (tabId === 'comments') {
                    container.innerHTML = `<div class="${emptyClass}">No Active Discourse</div>`;
                } else {
                    container.innerHTML = `<div class="${emptyClass}">Registry Empty</div>`;
                }
                return;
            }

            container.innerHTML = data.map(item => templates[tabId](item)).join('');
            lucide.createIcons();
        }

        function getTabContainer(id) {
            const map = {
                posts: 'posts-container',
                users: 'users-container',
                comments: 'comments-container',
                categories: 'categories-container',
                resources: 'admin-resources-container'
            };
            return document.getElementById(map[id]);
        }

        // --- UI Templates ---

        const templates = {
            posts: (post) => {
                const safeTitle = sanitizeHTML(post.title);
                const thumb = post.featured_image || 'https://images.unsplash.com/photo-1581092160562-40aa08e78837?auto=format&fit=crop&q=80&w=200';
                return `
                    <div class="bg-white p-4 md:p-6 border-2 border-slate-900 flex flex-col md:flex-row items-start md:items-center gap-4 md:gap-6 group hover:shadow-tech-accent transition-all shadow-tech">
                        <div class="w-full md:w-32 aspect-video md:aspect-square overflow-hidden border-2 border-slate-900 bg-slate-50 relative shrink-0">
                            <img src="${thumb}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" />
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="px-2 py-0.5 bg-blue-600 text-white text-[9px] font-black uppercase tracking-widest border border-slate-900">${sanitizeHTML(post.categories?.name || 'GEN')}</span>
                                <span class="text-[9px] font-mono text-slate-400 uppercase tracking-widest">${formatDate(post.created_at)}</span>
                            </div>
                            <h3 class="text-base md:text-lg lg:text-xl font-black text-slate-900 group-hover:text-blue-600 transition-colors truncate uppercase leading-tight">${safeTitle}</h3>
                        </div>
                        <div class="flex items-center gap-2 w-full md:w-auto mt-2 md:mt-0">
                            <a href="create-post.html?edit=${post.id}" class="flex-1 md:flex-none btn btn-outline btn-sm text-[9px] font-black uppercase tracking-widest rounded-none border-2 border-slate-900 hover:bg-slate-900 h-10 md:h-8">Edit</a>
                            <button onclick="window.dispatchAction('deletePost', '${post.id}')" class="flex-1 md:flex-none btn btn-error btn-sm text-[9px] font-black uppercase tracking-widest rounded-none border-2 border-slate-900 text-white h-10 md:h-8">Delete</button>
                        </div>
                    </div>
                `;
            },
            users: (u) => {
                const userRole = u.role || 'author';
                const isAdmin = userRole === 'admin' || userRole === 'administrator';
                return `
                    <div class="flex flex-col md:grid md:grid-cols-12 p-4 md:p-6 items-start md:items-center gap-4 hover:bg-slate-50 transition-colors">
                        <!-- User Info -->
                        <div class="col-span-1 md:col-span-6 flex items-center justify-between md:justify-start gap-4 w-full">
                            <a href="profile.html?id=${u.id}" class="flex items-center gap-4 min-w-0 group/u">
                                <div class="w-12 h-12 md:w-10 md:h-10 border-2 border-slate-900 overflow-hidden shrink-0 group-hover/u:border-blue-600 transition-colors">
                                    <img src="${u.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${u.id}`}" class="w-full h-full object-cover" alt="Avatar" />
                                </div>
                                <div class="min-w-0">
                                    <div class="font-bold text-slate-900 text-sm md:text-base uppercase truncate group-hover/u:text-blue-600 transition-colors underline-offset-4 group-hover/u:underline">${sanitizeHTML(u.full_name || 'No Name')}</div>
                                    <div class="text-[9px] font-mono text-slate-400 uppercase tracking-widest">ID: ${u.id.substring(0, 8)}</div>
                                </div>
                            </a>
                            <!-- Role Badge (Mobile Only) -->
                            <div class="md:hidden">
                                <span class="inline-block px-2 py-0.5 border-2 border-slate-900 text-[8px] font-black uppercase tracking-widest ${isAdmin ? 'bg-blue-600 text-white' : 'bg-white text-slate-900'}">
                                    ${userRole}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Role (Desktop Only) -->
                        <div class="hidden md:block md:col-span-3">
                            <span class="inline-block px-3 py-1 border-2 border-slate-900 text-[9px] font-black uppercase tracking-widest ${isAdmin ? 'bg-blue-600 text-white' : 'bg-white text-slate-900'}">
                                ${userRole}
                            </span>
                        </div>
                        
                        <!-- Actions -->
                        <div class="col-span-1 md:col-span-3 flex items-center gap-2 w-full md:justify-end">
                            <button onclick="window.dispatchAction('toggleRole', '${u.id}')" class="flex-1 md:flex-none btn btn-ghost btn-xs text-[10px] font-bold uppercase hover:bg-slate-900 hover:text-white rounded-none border border-slate-200 h-10 md:h-8 px-4">Change Role</button>
                            <button onclick="window.dispatchAction('purgeProfile', '${u.id}')" class="flex-1 md:flex-none btn btn-ghost btn-xs text-[10px] font-bold uppercase text-red-500 hover:bg-red-500 hover:text-white rounded-none border border-slate-200 h-10 md:h-8 px-4">Remove</button>
                        </div>
                    </div>
                `;
            },
            comments: (c) => `
                <div class="bg-white p-6 border-2 border-slate-900 shadow-tech relative group hover:shadow-tech-accent transition-all">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 border-2 border-slate-900 overflow-hidden">
                                <img src="${c.profiles?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${c.user_id}`}" alt="Avatar" />
                            </div>
                            <div>
                                <div class="text-[10px] font-black uppercase tracking-widest text-slate-900">${sanitizeHTML(c.profiles?.full_name || 'User')}</div>
                                <div class="text-[9px] font-mono text-slate-400 uppercase tracking-widest">Posted on: ${sanitizeHTML(c.posts?.title || 'Unknown Post')}</div>
                            </div>
                        </div>
                        <button onclick="window.dispatchAction('purgeComment', '${c.id}')" class="text-red-500 hover:bg-red-500 hover:text-white p-2 border border-slate-200 transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="text-sm text-slate-600 leading-relaxed pl-4 border-l-4 border-blue-600 font-medium">${sanitizeHTML(c.content)}</div>
                </div>
            `,
            categories: (cat) => `
                <div class="bg-white p-6 border-2 border-slate-900 shadow-tech hover:shadow-tech-accent transition-all group">
                    <div class="flex justify-between items-start mb-6">
                        <div class="p-3 bg-slate-900 text-white transition-colors">
                            <i data-lucide="hash" class="w-6 h-6"></i>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.dispatchAction('editCategory', '${cat.id}')" class="btn btn-ghost border border-slate-200 rounded-none btn-sm hover:bg-slate-900 hover:text-white"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                            <button onclick="window.dispatchAction('purgeCategory', '${cat.id}')" class="btn btn-ghost border border-slate-200 rounded-none btn-sm text-red-500 hover:bg-red-500 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <h4 class="text-xl font-black uppercase tracking-tighter text-slate-900 mb-1">${sanitizeHTML(cat.name)}</h4>
                    <p class="text-[9px] font-mono font-bold text-slate-400 uppercase tracking-widest mb-4">Slug: ${sanitizeHTML(cat.slug)}</p>
                </div>
            `,
            resources: (r) => `
                <div class="bg-white p-4 md:p-6 border-2 border-slate-900 shadow-tech hover:shadow-tech-accent transition-all flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 group">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-slate-900 text-white transition-colors">
                            <i data-lucide="package" class="w-5 h-5"></i>
                        </div>
                        <div class="min-w-0">
                            <h4 class="font-black text-slate-900 uppercase text-sm truncate">${sanitizeHTML(r.title)}</h4>
                            <p class="text-[9px] font-mono font-bold text-slate-400 uppercase tracking-widest truncate">${sanitizeHTML(r.category)} | ${sanitizeHTML(r.file_info || 'File')}</p>
                        </div>
                    </div>
                    <button onclick="window.dispatchAction('purgeResource', '${r.id}')" class="w-full sm:w-auto btn btn-ghost border border-slate-200 rounded-none text-red-500 btn-sm font-black text-[9px] uppercase tracking-widest hover:bg-red-500 hover:text-white h-10 sm:h-8">Delete</button>
                </div>
            `
        };

        // --- Action Dispatcher ---

        window.dispatchAction = async (action, params) => {
            let result;

            switch (action) {
                case 'deletePost':
                    if (confirm('Are you sure you want to delete this post?')) {
                        result = await runAction('Delete Post', () => deletePost(params), 'Post removed');
                        if (!result.error) { loadStats(); loadTabData('posts'); }
                    }
                    break;
                case 'toggleRole':
                    const user = App.data.users.find(u => u.id === params);
                    if (!user) return;
                    const newRole = (user.role === 'admin' || user.role === 'administrator') ? 'author' : 'admin';
                    if (confirm(`Change the role for ${user.full_name} to ${newRole.toUpperCase()}?`)) {
                        result = await runAction('Change Role', () => supabase.from('profiles').update({ role: newRole }).eq('id', params), 'Role updated');
                        if (!result.error) loadTabData('users');
                    }
                    break;
                case 'purgeProfile':
                    if (confirm('Are you sure you want to remove this user?')) {
                        result = await runAction('Remove User', () => supabase.from('profiles').delete().eq('id', params), 'User removed');
                        if (!result.error) { loadStats(); loadTabData('users'); }
                    }
                    break;
                case 'purgeComment':
                    if (confirm('Delete this comment?')) {
                        result = await runAction('Delete Comment', () => deleteComment(params), 'Comment removed');
                        if (!result.error) { loadStats(); loadTabData('comments'); }
                    }
                    break;
                case 'editCategory':
                    const cat = App.data.categories.find(c => c.id === params);
                    if (cat) window.editCategoryModal(cat.id, cat.name, cat.slug);
                    break;
                case 'purgeCategory':
                    if (confirm('Delete this category?')) {
                        result = await runAction('Delete Category', () => deleteCategory(params), 'Category removed');
                        if (!result.error) loadTabData('categories');
                    }
                    break;
                case 'purgeResource':
                    if (confirm('Delete this resource?')) {
                        result = await runAction('Delete Resource', () => deleteResource(params), 'Resource removed');
                        if (!result.error) loadTabData('resources');
                    }
                    break;
            }
        };

        // --- Setup Logic ---

        function setupCoreUI() {
            const tabs = document.querySelectorAll('.sidebar-link');
            const searchInput = document.getElementById('global-search');
            const subtitle = document.getElementById('active-tab-subtitle');
            const breadcrumb = document.getElementById('active-tab-breadcrumb');
            const title = document.getElementById('active-tab-title');
            const actions = document.getElementById('tab-actions');

            tabs.forEach(tab => {
                tab.onclick = () => {
                    const id = tab.dataset.tab;
                    if (!id) return;

                    // Update global state
                    App.activeTab = id;
                    App.searchQuery = '';
                    searchInput.value = '';

                    // Toggle active class on sidebar links
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Toggle visibility of tab content sections
                    document.querySelectorAll('.tab-content').forEach(section => {
                        section.classList.toggle('hidden', section.id !== `tab-${id}`);
                    });

                    // Update page title and breadcrumb
                    const tabLabel = tab.querySelector('span')?.innerText || id;
                    breadcrumb.innerText = tabLabel;
                    title.innerText = tabLabel;

                    const subtitles = {
                        posts: 'Manage your articles',
                        users: 'Manage team and access',
                        comments: 'Manage reader feedback',
                        categories: 'Organize your content',
                        resources: 'Manage downloads and files'
                    };
                    subtitle.innerText = subtitles[id] || 'Dashboard';

                    // Update action buttons for this tab
                    renderActiveTabActions(id, actions);

                    // ALWAYS load fresh data for the selected tab
                    loadTabData(id);

                    // Close mobile sidebar if open
                    if (window.innerWidth < 1024) {
                        window.toggleMobileSidebar();
                    }
                };
            });

            searchInput.oninput = debounce((e) => {
                App.searchQuery = e.target.value;
                renderActiveTab();
            }, 300);

            // Set initial state for the first tab
            const firstTab = document.querySelector('.sidebar-link[data-tab="posts"]');
            if (firstTab) firstTab.classList.add('active');
        }

        function renderActiveTabActions(id, container) {
            const btnClass = "btn btn-primary rounded-none border-2 border-slate-900 shadow-tech font-bold uppercase tracking-widest text-[10px] px-8 w-full md:w-auto hover:bg-slate-900";
            const actions = {
                posts: `<a href="create-post.html" class="${btnClass}"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>New Post</a>`,
                categories: `<button onclick="window.openCreateCategory()" class="${btnClass}"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>Add Category</button>`,
                resources: `<button onclick="window.promptCreateResource()" class="${btnClass}"><i data-lucide="plus" class="w-4 h-4 mr-2"></i>Add Resource</button>`
            };
            container.innerHTML = actions[id] || '';
            lucide.createIcons();
        }

        function renderHeaderInfo(profile) {
            if (!profile) return;
            const header = document.getElementById('auth-header-info');
            if (!header) return;

            const fullName = sanitizeHTML(profile.full_name || 'Admin');
            const roleName = (profile.role || 'author').toUpperCase();

            header.innerHTML = `
                <div class="hidden md:flex flex-col text-right">
                    <span class="text-sm font-bold text-slate-900">${fullName}</span>
                    <span class="text-[9px] font-mono font-bold text-blue-600 uppercase tracking-widest">${roleName}</span>
                </div>
                <div class="w-10 h-10 border-2 border-slate-900 p-0.5 overflow-hidden shadow-tech-accent shrink-0 bg-white">
                    <img src="${profile.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${profile.id}`}" class="w-full h-full object-cover" alt="Profile" />
                </div>
            `;
        }

        // --- Global Helper Modals ---

        window.openCreateCategory = () => {
            // Reset UI and global edit ID
            window._editingCategoryId = null;
            document.getElementById('cat-name').value = '';
            document.getElementById('cat-slug').value = '';
            document.getElementById('category-modal-title').innerText = 'New Category';
            document.getElementById('modal-category').checked = true;
        }

        window.editCategoryModal = (id, name, slug) => {
            window._editingCategoryId = id;
            document.getElementById('cat-name').value = name;
            document.getElementById('cat-slug').value = slug;
            document.getElementById('category-modal-title').innerText = 'Edit Category';
            document.getElementById('modal-category').checked = true;
        };

        document.getElementById('save-category-btn').onclick = async () => {
            const name = document.getElementById('cat-name').value;
            const slug = document.getElementById('cat-slug').value;
            if (!name) return showToast('Name is required', 'error');

            const task = window._editingCategoryId ? 'Edit Category' : 'Add Category';
            const action = window._editingCategoryId
                ? () => updateCategory(window._editingCategoryId, { name, slug })
                : () => createCategory({ name, slug });

            const res = await runAction(task, action, 'Category saved successfully');
            if (!res.error) {
                document.getElementById('modal-category').checked = false;
                loadTabData('categories');
            }
        };

        window.promptCreateResource = () => {
            document.getElementById('res-title').value = '';
            document.getElementById('res-file').value = '';
            document.getElementById('modal-resource').checked = true;
        };

        document.getElementById('save-resource-btn').onclick = async () => {
            const title = document.getElementById('res-title').value;
            const category = document.getElementById('res-category').value;
            const file_info = document.getElementById('res-file').value;
            if (!title) return showToast('Title is required', 'error');

            const res = await runAction('Add Resource', () => createResource({ title, category, file_info }), 'Resource added successfully');
            if (!res.error) {
                document.getElementById('modal-resource').checked = false;
                loadTabData('resources');
            }
        };

        window.toggleMobileSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('mobile-backdrop');
            sidebar.classList.toggle('-translate-x-full');
            sidebar.classList.toggle('translate-x-0');
            backdrop.classList.toggle('active');
        };

        window.performSignOut = async () => {
            if (confirm('Are you sure you want to sign out?')) {
                await signOut();
                window.location.href = 'index.html';
            }
        };

        // --- Notification Helpers ---

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast-item p-4 shadow-tech flex items-center gap-4 transition-all duration-500 transform translate-x-full opacity-0 ${type === 'success' ? 'border-l-green-500' : type === 'error' ? 'border-l-red-500' : 'border-l-blue-600'
                }`;

            const icons = { success: 'check-circle', error: 'alert-circle', info: 'info' };
            const colors = { success: 'text-green-600', error: 'text-red-600', info: 'text-blue-600' };

            toast.innerHTML = `
                <div class="${colors[type]}"><i data-lucide="${icons[type]}" class="w-6 h-6"></i></div>
                <div class="flex-1">
                    <div class="text-[10px] font-mono font-bold uppercase opacity-50 tracking-widest">${type}</div>
                    <div class="text-xs font-bold text-slate-900">${message}</div>
                </div>
            `;

            container.appendChild(toast);
            lucide.createIcons();

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            });

            // Animate out
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        function showUnauthorized() {
            document.body.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-slate-950 text-white p-10 text-center">
                    <div class="max-w-md">
                        <div class="w-20 h-20 bg-red-600 text-white flex items-center justify-center mx-auto mb-8 border-2 border-white shadow-tech"><i data-lucide="shield-alert" class="w-10 h-10"></i></div>
                        <h1 class="text-3xl font-black mb-4 uppercase tracking-tighter">Access Denied</h1>
                        <p class="text-slate-400 font-mono text-[10px] uppercase tracking-widest mb-10 leading-relaxed">You do not have permission to view this page.</p>
                        <a href="index.html" class="btn btn-primary rounded-none font-black uppercase tracking-widest text-[10px] px-10 h-14 border-2 border-white shadow-tech">Go Back Home</a>
                    </div>
                </div>`;
            lucide.createIcons();
            document.documentElement.classList.add('admin-ready');
        }

        function showSystemError(msg) {
            document.body.innerHTML = `<div class="p-20 text-red-500 font-mono text-xs uppercase tracking-widest flex items-center gap-4"><i data-lucide="terminal" class="w-5 h-5"></i>CORE_FAILURE: ${msg}</div>`;
            lucide.createIcons();
            document.documentElement.classList.add('admin-ready');
        }

        init();
    </script>
</body>

</html>