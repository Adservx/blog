<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Report | Voltage & Current</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Tailwind & DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- EasyMDE for Rich Text -->
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                }
            }
        }
    </script>

    <style>
        .EasyMDEContainer .CodeMirror {
            border-radius: 1rem;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            font-size: 1rem;
            min-height: 400px;
        }
        .editor-toolbar {
            border: none;
            background: #f8fafc;
            border-radius: 1rem 1rem 0 0;
            padding: 0.75rem;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-[1400px] mx-auto px-4 sm:px-10">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-8">
                    <a href="index.html" class="flex items-center gap-2">
                        <span class="text-2xl">âš¡</span>
                        <span class="font-serif text-lg font-black tracking-tight text-slate-900 uppercase">Voltage & Current</span>
                    </a>
                    <span class="h-6 w-px bg-slate-200 hidden sm:block"></span>
                    <h2 class="text-xs font-black uppercase tracking-[0.2em] text-slate-400 hidden sm:block">Report Drafting Module</h2>
                </div>

                <div class="flex items-center gap-3">
                    <a href="index.html" class="btn btn-ghost btn-sm font-bold uppercase tracking-widest text-[10px]">Cancel</a>
                    <button id="publish-btn" class="btn btn-primary btn-sm px-6 font-bold uppercase tracking-widest text-[10px]">Publish Report</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-[1400px] mx-auto px-4 sm:px-10 py-12">
        <div class="bg-white rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
            <div class="p-8 sm:p-16">
                
                <div class="space-y-10">
                    <!-- Title Input -->
                    <div class="space-y-4">
                        <label class="text-[10px] font-black uppercase tracking-[0.3em] text-slate-400">Publication Title</label>
                        <input type="text" id="post-title" placeholder="e.g. Advancements in Solid-State Transformer Design" 
                            class="w-full text-3xl md:text-5xl font-serif font-black text-slate-900 border-none focus:ring-0 placeholder:text-slate-200 p-0" />
                    </div>

                    <!-- Meta Inputs -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 py-8 border-y border-slate-50">
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text text-[10px] font-black uppercase tracking-widest text-slate-400">Technical Category</span>
                            </label>
                            <select id="post-category" class="select select-bordered w-full bg-slate-50 border-slate-200 font-bold uppercase tracking-wider text-xs">
                                <option value="1">Power Systems</option>
                                <option value="2">Electronics</option>
                                <option value="3">Control Systems</option>
                                <option value="4">Renewable Energy</option>
                            </select>
                        </div>
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text text-[10px] font-black uppercase tracking-widest text-slate-400">Header Image URL</span>
                            </label>
                            <input type="text" id="post-image" placeholder="https://unsplash.com/..." class="input input-bordered w-full bg-slate-50 border-slate-200 text-sm font-medium" />
                        </div>
                    </div>

                    <!-- Content Editor -->
                    <div class="space-y-4">
                        <label class="text-[10px] font-black uppercase tracking-[0.3em] text-slate-400">Technical Content</label>
                        <textarea id="post-editor"></textarea>
                    </div>
                </div>

            </div>
        </div>

        <p class="mt-8 text-center text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">
            Content will be peer-reviewed by the EE community upon publication.
        </p>
    </main>

    <script type="module">
        import { requireAuth } from './js/auth.js';
        import { createPost } from './js/posts.js';
        import { slugify } from './js/utils.js';

        let user = null;
        let easyMDE = null;

        async function init() {
            user = await requireAuth();
            if (!user) return;

            // Initialize Editor
            easyMDE = new EasyMDE({
                element: document.getElementById('post-editor'),
                placeholder: "Begin documenting your technical findings...",
                spellChecker: false,
                status: false,
                autosave: {
                    enabled: true,
                    uniqueId: "ee-blog-draft",
                    delay: 1000,
                },
                toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "table", "|", "preview", "side-by-side", "fullscreen", "|", "guide"]
            });
        }

        document.getElementById('publish-btn').onclick = async () => {
            const title = document.getElementById('post-title').value;
            const categoryId = document.getElementById('post-category').value;
            const imageUrl = document.getElementById('post-image').value;
            const content = easyMDE.options.previewRender(easyMDE.value()); // Convert MD to HTML for display

            if (!title || !easyMDE.value()) {
                alert('CRITICAL_ERROR: Title and Content are mandatory for publication.');
                return;
            }

            const publishBtn = document.getElementById('publish-btn');
            publishBtn.disabled = true;
            publishBtn.innerHTML = '<span class="loading loading-spinner"></span> PUBLISHING...';

            const slug = slugify(title) + '-' + Math.random().toString(36).substring(7);

            const postData = {
                title,
                content,
                user_id: user.id,
                category_id: parseInt(categoryId),
                slug,
                featured_image: imageUrl,
                excerpt: easyMDE.value().substring(0, 200).replace(/[#*`]/g, '') + '...'
            };

            const { data, error } = await createPost(postData);

            if (error) {
                alert('PUBLICATION_FAILED: ' + error.message);
                publishBtn.disabled = false;
                publishBtn.innerText = 'Publish Report';
            } else {
                window.location.href = `post.html?slug=${slug}`;
            }
        };

        init();
    </script>
</body>
</html>